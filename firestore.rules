rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Şirket bazında veri erişimi temel fonksiyonu
    function isCompanyMember(companyId) {
      return request.auth != null && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.companyId == companyId;
    }

    // Kullanıcı yetkilerini kontrol et
    function isAdmin() {
      return request.auth != null && 
             (get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.rol == 'yonetici' ||
              get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.rol == 'superadmin');
    }

    function isTechnician() {
      return request.auth != null && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.rol == 'tekniker';
    }

    function isEngineer() {
      return request.auth != null && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.rol == 'muhendis';
    }

    function isCustomer() {
      return request.auth != null && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.rol == 'musteri';
    }

    function isSuperAdmin() {
      return request.auth != null && 
             get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.rol == 'superadmin';
    }

    // Saha Erişim Kontrolü
    function canAccessSite(sahaId) {
      let user = get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data;
      return request.auth != null && 
             (user.rol == 'superadmin' || 
              (user.rol == 'musteri' && sahaId in user.sahalar) ||
              user.companyId == resource.data.companyId);
    }

    // Kullanıcılar koleksiyonu
    match /kullanicilar/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.companyId != null;
      allow update: if request.auth != null && 
                      (request.auth.uid == userId || isAdmin() || isSuperAdmin());
      allow delete: if isAdmin() || isSuperAdmin();
    }

    // Şirketler koleksiyonu
    match /companies/{companyId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || 
                     get(/databases/$(database)/documents/kullanicilar/$(request.auth.uid)).data.companyId == companyId);
      allow write: if isSuperAdmin();
    }

    // Arızalar koleksiyonu
    match /arizalar/{arizaId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow create: if request.auth != null && 
                      (isAdmin() || isEngineer() || isTechnician());
      allow update: if request.auth != null && 
                      (isAdmin() || isEngineer() || isTechnician());
      allow delete: if isAdmin() || isSuperAdmin();
    }

    // Sahalar koleksiyonu
    match /sahalar/{sahaId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || canAccessSite(sahaId));
      allow write: if isAdmin() || isSuperAdmin();
    }

    // Santraller koleksiyonu
    match /santraller/{santralId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || canAccessSite(santralId));
      allow write: if isAdmin() || isSuperAdmin();
    }

    // Stoklar koleksiyonu
    match /stoklar/{stokId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // Bildirimler koleksiyonu
    match /bildirimler/{bildirimId} {
      allow read: if request.auth != null && 
                    (request.auth.uid == resource.data.kullaniciId || isSuperAdmin());
      allow write: if request.auth != null;
    }

    // Davvetiyeler koleksiyonu
    match /davetiyeler/{davetiyeId} {
      allow read: if request.auth != null;
      allow write: if isAdmin() || isSuperAdmin();
    }

    // Mekanik Bakımlar koleksiyonu
    match /mekanikBakimlar/{bakimId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // Elektrik Bakımlar koleksiyonu
    match /elektrikBakimlar/{bakimId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // İş Raporları koleksiyonu
    match /isRaporlari/{raporId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // Elektrik Kesintileri koleksiyonu
    match /elektrikKesintileri/{kesintId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // İnvertör Kontrolleri koleksiyonu
    match /invertorKontroller/{kontrolId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // Üretim Verileri koleksiyonu
    match /uretimVerileri/{veriId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isTechnician() || isEngineer() || isSuperAdmin();
    }

    // Ekip koleksiyonu
    match /ekip/{ekipId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isSuperAdmin();
    }

    // Müşteriler koleksiyonu
    match /musteriler/{musteriId} {
      allow read: if request.auth != null && 
                    (isSuperAdmin() || isCompanyMember(resource.data.companyId));
      allow write: if isAdmin() || isSuperAdmin();
    }
  }
}